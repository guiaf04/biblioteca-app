#!/bin/bash

# Script de deploy da aplicaÃ§Ã£o Biblioteca na instÃ¢ncia EC2

set -e

# VariÃ¡veis de ambiente passadas pelo Ansible
AWS_REGION="{{ aws_region }}"
BACKEND_IMAGE="{{ backend_image }}"
FRONTEND_IMAGE="{{ frontend_image }}"
APP_DIRECTORY="{{ app_directory }}"
APP_USER="{{ app_user }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# Login no ECR
log "ğŸ” Fazendo login no ECR..."
aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $(echo $BACKEND_IMAGE | cut -d'/' -f1)

# Pull das imagens mais recentes
log "ğŸ“¥ Baixando imagens mais recentes..."
docker pull $BACKEND_IMAGE || log "âš ï¸ Falha ao baixar imagem do backend"
docker pull $FRONTEND_IMAGE || log "âš ï¸ Falha ao baixar imagem do frontend"

# Parar containers existentes
log "ğŸ›‘ Parando containers existentes..."
docker-compose -f $APP_DIRECTORY/docker-compose.yml down || true

# Remover imagens antigas (manter apenas as 3 mais recentes)
log "ğŸ§¹ Limpando imagens antigas..."
docker images --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | grep biblioteca | tail -n +4 | awk 

# Iniciar aplicaÃ§Ã£o
log "ğŸš€ Iniciando aplicaÃ§Ã£o..."
docker-compose -f $APP_DIRECTORY/docker-compose.yml up -d

# Aguardar containers ficarem saudÃ¡veis
log "â³ Aguardando containers ficarem saudÃ¡veis..."
sleep 30

# Verificar status
log "ğŸ“Š Verificando status dos containers..."
docker-compose -f $APP_DIRECTORY/docker-compose.yml ps

# Testar conectividade
log "ğŸ§ª Testando conectividade..."
sleep 10

if curl -s http://localhost:8080/api/livros/estatisticas > /dev/null; then
    log "âœ… Backend estÃ¡ respondendo!"
else
    log "âš ï¸ Backend pode nÃ£o estar pronto ainda"
fi

if curl -s http://localhost > /dev/null; then
    log "âœ… Frontend estÃ¡ respondendo!"
else
    log "âš ï¸ Frontend pode nÃ£o estar pronto ainda"
fi

log "ğŸ‰ Deploy concluÃ­do!"

